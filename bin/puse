#!/usr/bin/env bash
# puse - Project Use: orchestrate project requirement changes
#
# Usage:
#   puse <tool> [options]    - Install/configure a tool for the detected stack
#   puse --list              - List available tools for detected stack
#   puse --stack             - Show detected stack
#   puse --help              - Show this help
#
# Options:
#   --lic <name|index>       - Use license from tynn.config (by name or index)
#   --browser                - Enable browser testing (for pest, playwright)
#
# Tools by Stack:
#   Laravel:     pest, pest --browser, flux (requires --lic)
#   Node.js:     vitest, jest, playwright, prisma, drizzle
#   Django:      pytest, playwright
#   Go:          (coming soon)
#
# Examples:
#   puse pest                - Install Pest (Laravel)
#   puse pest --browser      - Install Pest with browser testing
#   puse flux --lic myflux   - Install Flux Pro with license
#   puse vitest              - Install Vitest (Node.js)

set -euo pipefail

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Setup
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Source bashrc to load aliases
if [[ -f "${HOME}/.bashrc" ]]; then
  source "${HOME}/.bashrc" 2>/dev/null || true
  shopt -s expand_aliases 2>/dev/null || true
fi

# Find script directory and source libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$REPO_ROOT/lib/helpers.sh"
source "$REPO_ROOT/lib/stacks.sh"
source "$REPO_ROOT/lib/licenses.sh"

# Source config if exists
CONFIG_FILE="$REPO_ROOT/tynn.config"
if [[ -f "$CONFIG_FILE" ]]; then
  source "$CONFIG_FILE"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Global options (parsed from args)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

LIC_REF=""
BROWSER_FLAG=false

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Tool Installers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

install_pest() {
  local browser_flag="${1:-false}"

  need_cmd composer
  need_file composer.json

  log "Setting up Pest 4..."

  # Remove PHPUnit if it exists
  if composer show phpunit/phpunit >/dev/null 2>&1; then
    log "Removing PHPUnit..."
    composer remove phpunit/phpunit --no-interaction >/dev/null 2>&1 || true
  fi

  # Install Pest
  log "Installing Pest 4..."
  yes n | composer require pestphp/pest --dev --with-all-dependencies --no-scripts --no-interaction >/dev/null 2>&1 && ok "Pest installed" || warn "Pest install may have issues"

  # Clean vendor to avoid autoloader conflicts
  if [[ -d "vendor" ]]; then
    log "Rebuilding vendor dependencies..."
    rm -rf vendor
    composer install --no-interaction --no-scripts >/dev/null 2>&1 && ok "Dependencies rebuilt" || warn "Dependency rebuild may have issues"
  fi

  # Initialize Pest
  log "Initializing Pest configuration..."
  php vendor/bin/pest --init

  # Browser testing (optional)
  if [[ "$browser_flag" == "true" ]]; then
    install_pest_browser
  fi

  echo ""
  ok "Pest 4 setup complete!"
  echo ""
  echo "ðŸš€ Run your tests with: php vendor/bin/pest"
}

install_pest_browser() {
  log "Setting up browser testing support..."

  need_cmd npm

  # Install browser plugin
  log "Installing Pest browser plugin..."
  yes n | composer require pestphp/pest-plugin-browser --dev --no-interaction >/dev/null 2>&1 && ok "Browser plugin installed" || warn "Browser plugin install may have issues"

  # Install Playwright
  log "Installing Playwright..."
  npm install playwright@latest >/dev/null 2>&1 && ok "Playwright installed" || warn "Playwright install may have issues"

  # Install Playwright browsers
  log "Installing Playwright browsers..."
  npx playwright install >/dev/null 2>&1 && ok "Browsers installed" || warn "Browser install may have issues"

  # Update .gitignore
  if [[ -f ".gitignore" ]]; then
    if ! grep -q "^tests/Browser/Screenshots" .gitignore; then
      echo "" >> .gitignore
      echo "# Pest browser test screenshots" >> .gitignore
      echo "tests/Browser/Screenshots" >> .gitignore
      ok "Added tests/Browser/Screenshots to .gitignore"
    fi
  fi

  ok "Browser testing support installed!"
  echo ""
  echo "ðŸ’¡ Example browser test:"
  echo "   it('may welcome the user', function () {"
  echo "       \$page = visit('/');"
  echo "       \$page->assertSee('Welcome');"
  echo "   });"
}

install_vitest() {
  local pm pm_install pm_dev

  pm=$(detect_node_pm)
  pm_install=$(node_pm_install)
  pm_dev=$(node_pm_dev_flag)

  need_file package.json

  log "Installing Vitest with $pm..."

  $pm_install $pm_dev vitest @vitest/ui >/dev/null 2>&1 && ok "Vitest installed" || die "Vitest install failed"

  # Add test script to package.json if not present
  if ! grep -q '"test"' package.json; then
    log "Adding test script to package.json..."
    node -e "
      const fs = require('fs');
      const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
      pkg.scripts = pkg.scripts || {};
      pkg.scripts.test = 'vitest';
      pkg.scripts['test:ui'] = 'vitest --ui';
      fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
    " && ok "Added test scripts"
  fi

  echo ""
  ok "Vitest setup complete!"
  echo ""
  echo "ðŸš€ Run your tests with: $pm_install test"
}

install_jest() {
  local pm pm_install pm_dev

  pm=$(detect_node_pm)
  pm_install=$(node_pm_install)
  pm_dev=$(node_pm_dev_flag)

  need_file package.json

  log "Installing Jest with $pm..."

  $pm_install $pm_dev jest @types/jest >/dev/null 2>&1 && ok "Jest installed" || die "Jest install failed"

  # Add test script
  if ! grep -q '"test"' package.json; then
    node -e "
      const fs = require('fs');
      const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
      pkg.scripts = pkg.scripts || {};
      pkg.scripts.test = 'jest';
      fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
    " && ok "Added test script"
  fi

  echo ""
  ok "Jest setup complete!"
  echo ""
  echo "ðŸš€ Run your tests with: $pm_install test"
}

install_playwright_node() {
  local pm_exec
  pm_exec=$(node_pm_exec)

  need_file package.json

  log "Installing Playwright..."

  npm install -D @playwright/test >/dev/null 2>&1 && ok "Playwright installed" || die "Playwright install failed"

  log "Installing browsers..."
  $pm_exec playwright install >/dev/null 2>&1 && ok "Browsers installed" || warn "Browser install may have issues"

  echo ""
  ok "Playwright setup complete!"
  echo ""
  echo "ðŸš€ Run tests with: $pm_exec playwright test"
}

install_flux() {
  local stack="$1"
  local lic_ref="$2"

  need_cmd composer
  need_cmd php
  need_file artisan

  # Get license params
  local lic_params=""
  local lic_email=""
  local lic_key=""

  if [[ -n "$lic_ref" ]]; then
    lic_params=$(get_license "flux" "$stack" "$lic_ref") || true
  elif has_license "flux" "$stack"; then
    # Try to get first available license
    lic_params=$(get_license "flux" "$stack" "0") || true
  fi

  if [[ -n "$lic_params" ]]; then
    lic_email=$(lic_param "$lic_params" 0) || true
    lic_key=$(lic_param "$lic_params" 1) || true
  fi

  if [[ -z "$lic_email" || -z "$lic_key" ]]; then
    echo ""
    warn "No license found for Flux."
    echo ""
    echo "Flux Pro requires a license. Options:"
    echo ""
    echo "1. Add license to tynn.config:"
    echo "   LICENSES='["
    echo "     {\"name\": \"myflux\", \"stack\": \"laravel\", \"tool\": \"flux\", \"params\": [\"email@example.com\", \"FL-XXXX-XXXX\"]}"
    echo "   ]'"
    echo ""
    echo "2. Then run: puse flux --lic myflux"
    echo ""
    echo "3. Or purchase at: https://flux.livewire.com"
    echo ""

    if has_license "flux" "$stack"; then
      echo "Available licenses:"
      list_licenses "flux" "$stack"
      echo ""
    fi

    die "License required for Flux Pro installation"
  fi

  log "Installing Flux Pro..."
  log "Using license: $lic_email"

  # Configure composer auth for flux-pro private repo
  log "Configuring composer authentication..."
  composer config repositories.flux-pro '{"type": "composer", "url": "https://composer.fluxui.dev"}' 2>/dev/null
  composer config http-basic.composer.fluxui.dev "$lic_email" "$lic_key" 2>/dev/null
  ok "Composer auth configured"

  # Check if Livewire is installed
  if ! composer show livewire/livewire >/dev/null 2>&1; then
    log "Installing Livewire (required by Flux)..."
    composer require livewire/livewire >/dev/null 2>&1 && ok "Livewire installed" || die "Livewire install failed"
  fi

  # Install Flux Pro
  log "Installing Flux Pro package..."
  composer require livewire/flux-pro >/dev/null 2>&1 && ok "Flux Pro installed" || die "Flux Pro install failed"

  # Publish assets and run install
  log "Running Flux installation..."
  php artisan flux:install

  echo ""
  ok "Flux Pro setup complete!"
  echo ""
  echo "ðŸ’¡ Documentation: https://fluxui.dev/docs"
}

install_pytest_django() {
  local py_cmd py_pm

  py_cmd="python"
  command -v python3 >/dev/null 2>&1 && py_cmd="python3"
  py_pm=$(detect_python_pm)

  need_file manage.py

  log "Installing pytest-django with $py_pm..."

  case "$py_pm" in
    poetry)
      poetry add --dev pytest pytest-django >/dev/null 2>&1 && ok "pytest-django installed" || die "Install failed"
      ;;
    uv)
      uv pip install pytest pytest-django >/dev/null 2>&1 && ok "pytest-django installed" || die "Install failed"
      ;;
    *)
      pip install pytest pytest-django >/dev/null 2>&1 && ok "pytest-django installed" || die "Install failed"
      ;;
  esac

  # Create pytest.ini if not exists
  if [[ ! -f "pytest.ini" ]]; then
    log "Creating pytest.ini..."
    cat > pytest.ini << 'EOF'
[pytest]
DJANGO_SETTINGS_MODULE = config.settings
python_files = tests.py test_*.py *_tests.py
EOF
    ok "Created pytest.ini"
  fi

  echo ""
  ok "pytest-django setup complete!"
  echo ""
  echo "ðŸš€ Run tests with: pytest"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Tool Routing
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Map of tools to stacks that support them
declare -A TOOL_STACKS=(
  ["pest"]="laravel"
  ["flux"]="laravel"
  ["vitest"]="node node-prisma node-drizzle node-knex node-sequelize node-typeorm"
  ["jest"]="node node-prisma node-drizzle node-knex node-sequelize node-typeorm"
  ["playwright"]="laravel node node-prisma node-drizzle node-knex node-sequelize node-typeorm django"
  ["pytest"]="django flask-alembic"
  ["prisma"]="node"
  ["drizzle"]="node"
)

# Tools that require licenses
declare -A TOOL_REQUIRES_LICENSE=(
  ["flux"]="true"
)

# Get tools available for a stack
get_tools_for_stack() {
  local stack="$1"
  local tools=()

  for tool in "${!TOOL_STACKS[@]}"; do
    if [[ " ${TOOL_STACKS[$tool]} " == *" $stack "* ]]; then
      tools+=("$tool")
    fi
  done

  echo "${tools[*]}"
}

# Check if tool is supported for stack
is_tool_supported() {
  local tool="$1"
  local stack="$2"

  [[ -v TOOL_STACKS[$tool] ]] && [[ " ${TOOL_STACKS[$tool]} " == *" $stack "* ]]
}

# Route to appropriate installer
route_tool() {
  local tool="$1"
  local stack="$2"

  # Check stack restrictions
  if ! is_stack_allowed "$stack"; then
    die "Stack '$stack' is not allowed by your tynn.config"
  fi

  # Check tool restrictions
  if ! is_tool_allowed "$stack" "$tool"; then
    die "Tool '$tool' is not allowed for stack '$stack' by your tynn.config"
  fi

  # Check if tool is supported for this stack
  if ! is_tool_supported "$tool" "$stack"; then
    local available
    available=$(get_tools_for_stack "$stack")
    die "Tool '$tool' is not supported for $(stack_name "$stack"). Available: $available"
  fi

  # Route to installer
  case "$tool" in
    pest)
      if [[ "$stack" != "laravel" ]]; then
        die "Pest is only for Laravel. For Node.js, try: puse vitest"
      fi
      install_pest "$BROWSER_FLAG"
      ;;

    flux)
      if [[ "$stack" != "laravel" ]]; then
        die "Flux is only for Laravel"
      fi
      install_flux "$stack" "$LIC_REF"
      ;;

    vitest)
      if ! is_node_stack "$stack"; then
        die "Vitest is only for Node.js projects. For Laravel, try: puse pest"
      fi
      install_vitest
      ;;

    jest)
      if ! is_node_stack "$stack"; then
        die "Jest is only for Node.js projects"
      fi
      install_jest
      ;;

    playwright)
      if [[ "$stack" == "laravel" ]]; then
        install_pest_browser
      elif is_node_stack "$stack"; then
        install_playwright_node
      else
        die "Playwright setup not yet implemented for $(stack_name "$stack")"
      fi
      ;;

    pytest)
      if ! is_python_stack "$stack"; then
        die "pytest is only for Python projects"
      fi
      install_pytest_django
      ;;

    *)
      die "Unknown tool: $tool"
      ;;
  esac
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

show_help() {
  sed -n '2,/^$/p' "$0" | sed 's/^# \?//'
}

show_stack() {
  local stack
  stack=$(detect_stack)
  echo "Detected stack: $(stack_name "$stack") ($stack)"
}

show_list() {
  local stack tools
  stack=$(detect_stack)

  if [[ "$stack" == "$STACK_UNKNOWN" ]]; then
    die "Could not detect project stack. Are you in a project directory?"
  fi

  echo "Stack: $(stack_name "$stack")"
  echo ""
  echo "Available tools:"

  tools=$(get_tools_for_stack "$stack")
  for tool in $tools; do
    local note=""
    if [[ -v TOOL_REQUIRES_LICENSE[$tool] ]]; then
      if has_license "$tool" "$stack"; then
        note=" (license configured)"
      else
        note=" (requires --lic)"
      fi
    fi
    echo "  - $tool$note"
  done
}

parse_args() {
  local tool=""
  local positional=()

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --help|-h)
        show_help
        exit 0
        ;;
      --stack)
        show_stack
        exit 0
        ;;
      --list|-l)
        show_list
        exit 0
        ;;
      --lic)
        if [[ -z "${2:-}" ]]; then
          die "--lic requires a license name or index"
        fi
        LIC_REF="$2"
        shift 2
        ;;
      --browser)
        BROWSER_FLAG=true
        shift
        ;;
      -*)
        die "Unknown option: $1. Use --help for usage."
        ;;
      *)
        positional+=("$1")
        shift
        ;;
    esac
  done

  # First positional arg is the tool
  if [[ ${#positional[@]} -eq 0 ]]; then
    show_help
    exit 0
  fi

  echo "${positional[0]}"
}

main() {
  local tool
  tool=$(parse_args "$@")

  local stack
  stack=$(detect_stack)

  if [[ "$stack" == "$STACK_UNKNOWN" ]]; then
    die "Could not detect project stack. Are you in a project directory?"
  fi

  log "Detected stack: $(stack_name "$stack")"
  route_tool "$tool" "$stack"
}

main "$@"
