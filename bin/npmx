#!/usr/bin/env bash
# npmx - Run package manager commands in subdirectories
#
# Usage:
#   npmx <directory> <args...>   - Run in specific directory
#   npmx <args...>               - Auto-detects single npm directory
#   npmx --list                  - List available directories
#   npmx --pm                    - Show detected package manager
#   npmx --help                  - Show this help
#
# Detects package manager (npm, pnpm, yarn, bun) from lock files.
#
# Examples:
#   npmx server test -- --run tests/services/chat.test.js
#   npmx client build
#   npmx test                    - Auto-detect if single package.json subdir

set -euo pipefail

# ─────────────────────────────────────────────────────────────────────────────
# Setup
# ─────────────────────────────────────────────────────────────────────────────

# Source bashrc to load aliases
if [[ -f "${HOME}/.bashrc" ]]; then
  source "${HOME}/.bashrc" 2>/dev/null || true
  shopt -s expand_aliases 2>/dev/null || true
fi

# Find script directory and source libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$REPO_ROOT/lib/helpers.sh"
source "$REPO_ROOT/lib/stacks.sh"

# ─────────────────────────────────────────────────────────────────────────────
# Find npm directories
# ─────────────────────────────────────────────────────────────────────────────

SEARCH_SUBDIRS=(server client frontend backend api web app packages)

find_npm_dirs() {
  local search_dir="$PWD"
  local npm_dirs=()

  while [[ "$search_dir" != "/" && "$search_dir" != "/c" ]]; do
    for subdir in "${SEARCH_SUBDIRS[@]}"; do
      if [[ -f "$search_dir/$subdir/package.json" ]]; then
        npm_dirs+=("$search_dir/$subdir")
      fi
    done

    if [[ -f "$search_dir/package.json" ]]; then
      npm_dirs+=("$search_dir")
    fi

    if [[ ${#npm_dirs[@]} -gt 0 ]]; then
      break
    fi
    search_dir="$(dirname "$search_dir")"
  done

  printf '%s\n' "${npm_dirs[@]}"
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

show_help() {
  sed -n '2,/^$/p' "$0" | sed 's/^# \?//'
}

show_list() {
  local dirs=("$@")
  info "Available npm directories:"
  for dir in "${dirs[@]}"; do
    echo "  $(basename "$dir")"
  done
}

main() {
  # Handle flags
  case "${1:-}" in
    --help|-h)
      show_help
      exit 0
      ;;
    --pm)
      local pm
      pm=$(detect_node_pm)
      echo "$pm"
      exit 0
      ;;
    --list|-l)
      local -a npm_dirs
      mapfile -t npm_dirs < <(find_npm_dirs)
      if [[ ${#npm_dirs[@]} -eq 0 ]]; then
        die "No package.json found in project hierarchy"
      fi
      show_list "${npm_dirs[@]}"
      exit 0
      ;;
  esac

  # Find npm directories
  local -a npm_dirs
  mapfile -t npm_dirs < <(find_npm_dirs)

  if [[ ${#npm_dirs[@]} -eq 0 ]]; then
    die "No package.json found in project hierarchy (looked for: ${SEARCH_SUBDIRS[*]} and root)"
  fi

  local target=""

  # If first arg is a directory name that contains package.json, use it
  if [[ -n "${1:-}" ]]; then
    for dir in "${npm_dirs[@]}"; do
      local dname
      dname="$(basename "$dir")"
      if [[ "$dname" == "$1" ]]; then
        target="$dir"
        shift
        break
      fi
    done
  fi

  # Auto-detect target if not specified
  if [[ -z "$target" ]]; then
    # Prefer subdirectories over root
    local -a subdir_npm_dirs=()
    local search_dir="$PWD"

    # Find root for comparison
    while [[ "$search_dir" != "/" && "$search_dir" != "/c" ]]; do
      if [[ -f "$search_dir/package.json" ]]; then
        break
      fi
      search_dir="$(dirname "$search_dir")"
    done

    for dir in "${npm_dirs[@]}"; do
      if [[ "$dir" != "$search_dir" ]]; then
        subdir_npm_dirs+=("$dir")
      fi
    done

    local -a dirs_to_check=("${npm_dirs[@]}")
    if [[ ${#subdir_npm_dirs[@]} -gt 0 ]]; then
      dirs_to_check=("${subdir_npm_dirs[@]}")
    fi

    if [[ ${#dirs_to_check[@]} -eq 1 ]]; then
      target="${dirs_to_check[0]}"
      log "Auto-selected: $(basename "$target")"
    else
      warn "Multiple npm directories found. Specify which one:"
      for dir in "${dirs_to_check[@]}"; do
        echo "   $(basename "$dir")" >&2
      done
      exit 1
    fi
  fi

  if [[ $# -eq 0 ]]; then
    die "No command specified"
  fi

  # Detect package manager
  local pm pm_run
  pm=$(detect_node_pm)
  pm_run=$(node_pm_run "$target")

  local dname
  dname="$(basename "$target")"
  log "Running in ${dname}/: $pm_run $*"
  echo ""

  (cd "$target" && $pm_run "$@")
}

main "$@"
