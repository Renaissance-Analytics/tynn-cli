#!/usr/bin/env bash
# Set up Pest 4 testing framework for Laravel projects
#
# Usage:
#   usepest              - Install Pest 4
#   usepest --browser    - Install Pest 4 with browser testing support
#
# This script:
# 1. Removes PHPUnit (if present)
# 2. Installs Pest 4
# 3. Initializes Pest configuration
# 4. Optionally sets up browser testing (with --browser flag)

set -euo pipefail

# Source bashrc to load aliases (e.g., composer might be an alias)
if [[ -f "${HOME}/.bashrc" ]]; then
  source "${HOME}/.bashrc" 2>/dev/null || true
  shopt -s expand_aliases 2>/dev/null || true
fi

# Parse flags
BROWSER_FLAG=false
for arg in "$@"; do
  case "$arg" in
    --browser)
      BROWSER_FLAG=true
      ;;
    *)
      echo "âš ï¸  Unknown argument: $arg" >&2
      echo "Usage: usepest [--browser]" >&2
      exit 1
      ;;
  esac
done

# Check if we're in a Laravel/PHP project
if [[ ! -f "composer.json" ]]; then
  echo "âŒ No composer.json found. Are you in a PHP/Laravel project directory?"
  exit 1
fi

# Check for required commands
command -v composer >/dev/null 2>&1 || { echo "âŒ composer command not found. Please install Composer first." >&2; exit 1; }

echo "âš¡ Setting up Pest 4..."

# Step 1: Remove PHPUnit if it exists
if composer show phpunit/phpunit >/dev/null 2>&1; then
  echo "ðŸ“¦ Removing PHPUnit..."
  echo "Expect this look like it failed, but it's okay"
  composer remove phpunit/phpunit --no-interaction >/dev/null 2>&1 || true
else
  echo "âœ… PHPUnit not found (or already removed)"
fi

# Step 2: Install Pest
echo "ðŸ“¦ Installing Pest 4..."
echo "Expect this look like it failed, but it's okay"
# Pipe "no" to skip Pest's "wanna show pest some love" interactive prompt
yes n | composer require pestphp/pest --dev --with-all-dependencies --no-scripts --no-interaction >/dev/null 2>&1 && echo "âœ…" || echo "âŒ"

# Step 2.5: Clean up vendor folder to avoid autoloader conflicts
# Removing PHPUnit and adding Pest can cause autoloader errors, so we rebuild
if [[ -d "vendor" ]]; then
  echo "ðŸ§¹ Cleaning vendor folder to resolve autoloader conflicts..."
  rm -rf vendor
  echo "ðŸ“¦ Reinstalling dependencies..."
  composer install --no-interaction --no-scripts >/dev/null 2>&1 && echo "âœ…" || echo "âŒ"
fi

# Step 3: Initialize Pest
echo "âš¡ Initializing Pest configuration..."
php vendor/bin/pest --init

# Step 4: Browser testing setup (if flag provided)
if [[ "$BROWSER_FLAG" == "true" ]]; then
  echo "ðŸŒ Setting up browser testing support..."
  
  # Check for npm/node
  if ! command -v npm >/dev/null 2>&1; then
    echo "âš ï¸  npm not found. Browser testing requires Node.js/npm."
    echo "   Please install Node.js first, then run:"
    echo "   composer require pestphp/pest-plugin-browser --dev"
    echo "   npm install playwright@latest"
    echo "   npx playwright install"
    exit 1
  fi
  
  # Install browser plugin
  echo "ðŸ“¦ Installing Pest browser plugin..."
  yes n | composer require pestphp/pest-plugin-browser --dev --no-interaction >/dev/null 2>&1 && echo "âœ…" || echo "âŒ"
  
  # Install Playwright
  echo "ðŸ“¦ Installing Playwright..."
  npm install playwright@latest >/dev/null 2>&1 && echo "âœ…" || echo "âŒ"
  
  # Install Playwright browsers
  echo "ðŸ“¦ Installing Playwright browsers..."
  npx playwright install >/dev/null 2>&1 && echo "âœ…" || echo "âŒ"
  
  # Add screenshots directory to .gitignore
  if [[ -f ".gitignore" ]]; then
    if ! grep -q "^tests/Browser/Screenshots" .gitignore; then
      echo "" >> .gitignore
      echo "# Pest browser test screenshots" >> .gitignore
      echo "tests/Browser/Screenshots" >> .gitignore
      echo "âœ… Added tests/Browser/Screenshots to .gitignore"
    else
      echo "âœ… tests/Browser/Screenshots already in .gitignore"
    fi
  else
    echo "âš ï¸  .gitignore not found. Consider adding: tests/Browser/Screenshots"
  fi
  
  echo "âœ… Browser testing support installed!"
fi

echo ""
echo "âœ… Pest 4 setup complete!"
if [[ "$BROWSER_FLAG" == "true" ]]; then
  echo ""
  echo "ðŸ’¡ You can now write browser tests. Example:"
  echo "   it('may welcome the user', function () {"
  echo "       \$page = visit('/');"
  echo "       \$page->assertSee('Welcome');"
  echo "   });"
fi
echo ""
echo "ðŸš€ Run your tests with: php vendor/bin/pest"
