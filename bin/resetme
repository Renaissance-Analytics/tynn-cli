#!/usr/bin/env bash
# resetme - Reset database/state for detected stack
#
# Usage: resetme [--seed] [--demo] [--dry-run] [--stack] [--help]
#
# Options:
#   --seed      Run default seeder after migrations
#   --demo      Run default seeder + DemoSeeder (implies --seed)
#   --dry-run   Show what would be executed without running
#   --stack     Show detected stack and exit
#   --help      Show this help message
#
# See STACKS.md for supported stacks and their reset behaviors.

set -euo pipefail

# ─────────────────────────────────────────────────────────────────────────────
# Setup
# ─────────────────────────────────────────────────────────────────────────────

# Source bashrc to load aliases
if [[ -f "${HOME}/.bashrc" ]]; then
  source "${HOME}/.bashrc" 2>/dev/null || true
  shopt -s expand_aliases 2>/dev/null || true
fi

# Find script directory and source libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$REPO_ROOT/lib/helpers.sh"
source "$REPO_ROOT/lib/stacks.sh"

# Source config if exists
CONFIG_FILE="$REPO_ROOT/tynn.config"
if [[ -f "$CONFIG_FILE" ]]; then
  source "$CONFIG_FILE"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Flags
# ─────────────────────────────────────────────────────────────────────────────

SEED=false
DEMO=false
DRY_RUN=false
SHOW_STACK=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --seed)    SEED=true; shift ;;
    --demo)    DEMO=true; SEED=true; shift ;;
    --dry-run) DRY_RUN=true; shift ;;
    --stack)   SHOW_STACK=true; shift ;;
    --help|-h)
      sed -n '2,/^$/p' "$0" | sed 's/^# \?//'
      exit 0
      ;;
    *)
      die "Unknown option: $1"
      ;;
  esac
done

# ─────────────────────────────────────────────────────────────────────────────
# Execution wrapper (respects --dry-run)
# ─────────────────────────────────────────────────────────────────────────────

run() {
  if [[ "$DRY_RUN" == true ]]; then
    log "[dry-run] $*"
  else
    log "Running: $*"
    "$@"
  fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Reset handlers for each stack
# ─────────────────────────────────────────────────────────────────────────────

reset_laravel() {
  need_cmd php

  local cmd="php artisan migrate:fresh"

  if [[ "$SEED" == true ]]; then
    cmd="$cmd --seed"
  fi

  run $cmd

  if [[ "$DEMO" == true ]]; then
    run php artisan db:seed --class=DemoSeeder
  fi

  ok "Laravel database reset complete"
}

reset_node_prisma() {
  local pm_exec
  pm_exec=$(node_pm_exec)

  run $pm_exec prisma migrate reset --force

  if [[ "$DEMO" == true ]]; then
    if [[ -f "prisma/seed.ts" || -f "prisma/seed.js" ]]; then
      run $pm_exec prisma db seed -- --demo
    else
      warn "No prisma/seed.ts or prisma/seed.js found for demo seeding"
    fi
  fi

  ok "Prisma database reset complete"
}

reset_node_drizzle() {
  local pm_exec pm_run
  pm_exec=$(node_pm_exec)
  pm_run=$(node_pm_run)

  run $pm_exec drizzle-kit drop
  run $pm_exec drizzle-kit push

  if [[ "$SEED" == true ]]; then
    if grep -q '"db:seed"' package.json 2>/dev/null; then
      run $pm_run db:seed
    elif [[ -f "src/db/seed.ts" || -f "db/seed.ts" ]]; then
      run $pm_exec tsx src/db/seed.ts 2>/dev/null || run $pm_exec tsx db/seed.ts
    else
      warn "No seed script found (add 'db:seed' to package.json scripts)"
    fi
  fi

  if [[ "$DEMO" == true ]]; then
    if grep -q '"db:seed:demo"' package.json 2>/dev/null; then
      run $pm_run db:seed:demo
    else
      warn "No db:seed:demo script found in package.json for demo seeding"
    fi
  fi

  ok "Drizzle database reset complete"
}

reset_node_knex() {
  local pm_exec
  pm_exec=$(node_pm_exec)

  run $pm_exec knex migrate:rollback --all
  run $pm_exec knex migrate:latest

  if [[ "$SEED" == true ]]; then
    run $pm_exec knex seed:run
  fi

  if [[ "$DEMO" == true ]]; then
    if [[ -d "seeds/demo" ]]; then
      run $pm_exec knex seed:run --specific=demo
    elif [[ -f "seeds/demo.js" || -f "seeds/demo.ts" ]]; then
      run $pm_exec knex seed:run --specific=demo.js 2>/dev/null || run $pm_exec knex seed:run --specific=demo.ts
    else
      warn "No demo seeds found (create seeds/demo/ directory or seeds/demo.js)"
    fi
  fi

  ok "Knex database reset complete"
}

reset_node_sequelize() {
  local pm_exec
  pm_exec=$(node_pm_exec)

  run $pm_exec sequelize-cli db:drop
  run $pm_exec sequelize-cli db:create
  run $pm_exec sequelize-cli db:migrate

  if [[ "$SEED" == true ]]; then
    run $pm_exec sequelize-cli db:seed:all
  fi

  if [[ "$DEMO" == true ]]; then
    if ls seeders/*demo* 1>/dev/null 2>&1; then
      for seeder in seeders/*demo*; do
        run $pm_exec sequelize-cli db:seed --seed "$(basename "$seeder")"
      done
    else
      warn "No demo seeders found (create seeders/*demo*.js files)"
    fi
  fi

  ok "Sequelize database reset complete"
}

reset_node_typeorm() {
  local pm_exec pm_run
  pm_exec=$(node_pm_exec)
  pm_run=$(node_pm_run)

  run $pm_exec typeorm schema:drop
  run $pm_exec typeorm migration:run

  if [[ "$SEED" == true || "$DEMO" == true ]]; then
    if grep -q '"db:seed"' package.json 2>/dev/null; then
      run $pm_run db:seed
    elif grep -q '"seed"' package.json 2>/dev/null; then
      run $pm_run seed
    else
      warn "No seed script found in package.json"
    fi
  fi

  if [[ "$DEMO" == true ]]; then
    if grep -q '"db:seed:demo"' package.json 2>/dev/null; then
      run $pm_run db:seed:demo
    fi
  fi

  ok "TypeORM database reset complete"
}

reset_django() {
  local py_cmd="python"
  command -v python3 >/dev/null 2>&1 && py_cmd="python3"
  need_cmd "$py_cmd"

  run $py_cmd manage.py flush --no-input
  run $py_cmd manage.py migrate

  if [[ "$SEED" == true ]]; then
    if [[ -d "fixtures" ]]; then
      for fixture in fixtures/*.json; do
        [[ -f "$fixture" ]] && run $py_cmd manage.py loaddata "$fixture"
      done
    elif $py_cmd manage.py help seed >/dev/null 2>&1; then
      run $py_cmd manage.py seed
    else
      warn "No fixtures/ directory or seed command found"
    fi
  fi

  if [[ "$DEMO" == true ]]; then
    if [[ -f "fixtures/demo.json" ]]; then
      run $py_cmd manage.py loaddata fixtures/demo.json
    elif $py_cmd manage.py help seed_demo >/dev/null 2>&1; then
      run $py_cmd manage.py seed_demo
    else
      warn "No fixtures/demo.json or seed_demo command found for demo seeding"
    fi
  fi

  ok "Django database reset complete"
}

reset_flask_alembic() {
  local py_cmd="python"
  command -v python3 >/dev/null 2>&1 && py_cmd="python3"
  need_cmd "$py_cmd"

  if command -v flask >/dev/null 2>&1 && [[ -f "migrations/alembic.ini" ]]; then
    run flask db downgrade base
    run flask db upgrade
  else
    run alembic downgrade base
    run alembic upgrade head
  fi

  if [[ "$SEED" == true || "$DEMO" == true ]]; then
    if [[ -f "seed.py" ]]; then
      run $py_cmd seed.py
    elif [[ -f "scripts/seed.py" ]]; then
      run $py_cmd scripts/seed.py
    else
      warn "No seed.py or scripts/seed.py found"
    fi
  fi

  if [[ "$DEMO" == true ]]; then
    if [[ -f "seed_demo.py" ]]; then
      run $py_cmd seed_demo.py
    elif [[ -f "scripts/seed_demo.py" ]]; then
      run $py_cmd scripts/seed_demo.py
    else
      warn "No seed_demo.py found for demo seeding"
    fi
  fi

  ok "Alembic database reset complete"
}

reset_go_migrate() {
  need_cmd migrate

  local db_url="${DATABASE_URL:-}"
  local migrations_path="./migrations"
  [[ -d "db/migrations" ]] && migrations_path="./db/migrations"

  if [[ -z "$db_url" ]]; then
    if [[ -f ".env" ]]; then
      db_url=$(grep -E "^DATABASE_URL=" .env | cut -d'=' -f2- | tr -d '"' | tr -d "'")
    fi
  fi

  [[ -z "$db_url" ]] && die "DATABASE_URL not set. Export it or add to .env"

  run migrate -path "$migrations_path" -database "$db_url" drop -f
  run migrate -path "$migrations_path" -database "$db_url" up

  if [[ "$SEED" == true || "$DEMO" == true ]]; then
    if [[ -f "cmd/seed/main.go" ]]; then
      run go run cmd/seed/main.go
    elif [[ -f "scripts/seed.go" ]]; then
      run go run scripts/seed.go
    else
      warn "No cmd/seed/main.go or scripts/seed.go found"
    fi
  fi

  if [[ "$DEMO" == true ]]; then
    if [[ -f "cmd/seed/main.go" ]]; then
      run go run cmd/seed/main.go --demo
    elif [[ -f "scripts/seed_demo.go" ]]; then
      run go run scripts/seed_demo.go
    else
      warn "No demo seed found (use --demo flag in seed or create scripts/seed_demo.go)"
    fi
  fi

  ok "Go database reset complete"
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

main() {
  local stack
  stack=$(detect_stack)

  if [[ "$SHOW_STACK" == true ]]; then
    echo "Detected stack: $(stack_name "$stack") ($stack)"
    exit 0
  fi

  if [[ "$stack" == "$STACK_UNKNOWN" ]]; then
    die "Could not detect project stack. See STACKS.md for supported stacks."
  fi

  # Check stack restrictions
  if ! is_stack_allowed "$stack"; then
    die "Stack '$stack' is not allowed by your tynn.config"
  fi

  log "Detected stack: $(stack_name "$stack")"

  case "$stack" in
    "$STACK_LARAVEL")        reset_laravel ;;
    "$STACK_NODE_PRISMA")    reset_node_prisma ;;
    "$STACK_NODE_DRIZZLE")   reset_node_drizzle ;;
    "$STACK_NODE_KNEX")      reset_node_knex ;;
    "$STACK_NODE_SEQUELIZE") reset_node_sequelize ;;
    "$STACK_NODE_TYPEORM")   reset_node_typeorm ;;
    "$STACK_NODE")
      warn "Generic Node.js project detected. No specific ORM found."
      warn "Supported ORMs: Prisma, Drizzle, Knex, Sequelize, TypeORM"
      die "Cannot reset database without a recognized ORM"
      ;;
    "$STACK_DJANGO")         reset_django ;;
    "$STACK_FLASK_ALEMBIC")  reset_flask_alembic ;;
    "$STACK_GO_MIGRATE")     reset_go_migrate ;;
    *)
      die "Reset not implemented for stack: $(stack_name "$stack")"
      ;;
  esac
}

main
