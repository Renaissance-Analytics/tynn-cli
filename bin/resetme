#!/usr/bin/env bash
# resetme - Reset database/state for detected project type
#
# Usage: resetme [--seed] [--demo] [--dry-run] [--help]
#
# Options:
#   --seed      Run default seeder after migrations
#   --demo      Run default seeder + DemoSeeder (implies --seed)
#   --dry-run   Show what would be executed without running
#   --help      Show this help message
#
# Supported environments:
#   - Laravel/PHP (artisan + composer.json)
#   - Node.js with Prisma (prisma in package.json)
#   - Node.js with Knex (knex in package.json)
#   - Node.js with Drizzle (drizzle-kit in package.json)
#   - Python/Django (manage.py + django)
#   - Python/Flask with Alembic (flask + alembic)
#   - Go with golang-migrate (go.mod + migrate tool)

set -euo pipefail

# Source bashrc to load aliases (e.g., php, composer might be aliases)
if [[ -f "${HOME}/.bashrc" ]]; then
  source "${HOME}/.bashrc" 2>/dev/null || true
  shopt -s expand_aliases 2>/dev/null || true
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helpers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

log()  { printf "ðŸ“‚ %s\n" "$*"; }
info() { printf "âš¡ %s\n" "$*"; }
warn() { printf "âš ï¸  %s\n" "$*" >&2; }
die()  { printf "âŒ %s\n" "$*" >&2; exit 1; }
ok()   { printf "âœ… %s\n" "$*"; }

need_cmd() { command -v "$1" >/dev/null 2>&1 || die "Missing required command: $1"; }

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Flags
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

SEED=false
DEMO=false
DRY_RUN=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --seed)    SEED=true; shift ;;
    --demo)    DEMO=true; SEED=true; shift ;;
    --dry-run) DRY_RUN=true; shift ;;
    --help|-h)
      sed -n '2,/^$/p' "$0" | sed 's/^# \?//'
      exit 0
      ;;
    *)
      die "Unknown option: $1"
      ;;
  esac
done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Execution wrapper (respects --dry-run)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

run() {
  if [[ "$DRY_RUN" == true ]]; then
    info "[dry-run] $*"
  else
    info "Running: $*"
    "$@"
  fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Environment detection
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

detect_env() {
  # Laravel/PHP
  if [[ -f "artisan" && -f "composer.json" ]]; then
    echo "laravel"
    return
  fi

  # Node.js projects
  if [[ -f "package.json" ]]; then
    local pkg
    pkg=$(cat package.json)

    # Prisma
    if echo "$pkg" | grep -q '"prisma"' || [[ -f "prisma/schema.prisma" ]]; then
      echo "prisma"
      return
    fi

    # Drizzle
    if echo "$pkg" | grep -q '"drizzle-kit"' || [[ -d "drizzle" ]]; then
      echo "drizzle"
      return
    fi

    # Knex
    if echo "$pkg" | grep -q '"knex"' || [[ -f "knexfile.js" || -f "knexfile.ts" ]]; then
      echo "knex"
      return
    fi

    # Sequelize
    if echo "$pkg" | grep -q '"sequelize"' || [[ -f ".sequelizerc" ]]; then
      echo "sequelize"
      return
    fi

    # TypeORM
    if echo "$pkg" | grep -q '"typeorm"'; then
      echo "typeorm"
      return
    fi
  fi

  # Python/Django
  if [[ -f "manage.py" ]]; then
    if [[ -f "requirements.txt" ]] && grep -qi "django" requirements.txt 2>/dev/null; then
      echo "django"
      return
    fi
    if [[ -f "pyproject.toml" ]] && grep -qi "django" pyproject.toml 2>/dev/null; then
      echo "django"
      return
    fi
    # Assume Django if manage.py exists
    echo "django"
    return
  fi

  # Python/Flask with Alembic
  if [[ -d "migrations" && -f "migrations/alembic.ini" ]] || [[ -f "alembic.ini" ]]; then
    echo "alembic"
    return
  fi

  # Go with migrations
  if [[ -f "go.mod" ]]; then
    if [[ -d "migrations" ]] || [[ -d "db/migrations" ]]; then
      echo "go-migrate"
      return
    fi
  fi

  echo "unknown"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Reset handlers for each environment
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

reset_laravel() {
  need_cmd php

  local cmd="php artisan migrate:fresh"

  if [[ "$SEED" == true ]]; then
    cmd="$cmd --seed"
  fi

  run $cmd

  if [[ "$DEMO" == true ]]; then
    run php artisan db:seed --class=DemoSeeder
  fi

  ok "Laravel database reset complete"
}

reset_prisma() {
  need_cmd npx

  # Prisma reset drops all data and re-runs migrations
  # --force skips confirmation prompt
  run npx prisma migrate reset --force

  if [[ "$DEMO" == true ]]; then
    # Convention: pass --demo flag to seed script
    if [[ -f "prisma/seed.ts" || -f "prisma/seed.js" ]]; then
      run npx prisma db seed -- --demo
    else
      warn "No prisma/seed.ts or prisma/seed.js found for demo seeding"
    fi
  fi

  ok "Prisma database reset complete"
}

reset_drizzle() {
  need_cmd npx

  # Drizzle: drop and push schema
  run npx drizzle-kit drop
  run npx drizzle-kit push

  if [[ "$SEED" == true ]]; then
    # Convention: look for seed script in package.json
    if grep -q '"db:seed"' package.json 2>/dev/null; then
      run npm run db:seed
    elif [[ -f "src/db/seed.ts" || -f "db/seed.ts" ]]; then
      run npx tsx src/db/seed.ts 2>/dev/null || run npx tsx db/seed.ts
    else
      warn "No seed script found (add 'db:seed' to package.json scripts)"
    fi
  fi

  if [[ "$DEMO" == true ]]; then
    if grep -q '"db:seed:demo"' package.json 2>/dev/null; then
      run npm run db:seed:demo
    else
      warn "No db:seed:demo script found in package.json for demo seeding"
    fi
  fi

  ok "Drizzle database reset complete"
}

reset_knex() {
  need_cmd npx

  # Rollback all and migrate fresh
  run npx knex migrate:rollback --all
  run npx knex migrate:latest

  if [[ "$SEED" == true ]]; then
    run npx knex seed:run
  fi

  if [[ "$DEMO" == true ]]; then
    # Convention: demo seeds in seeds/demo directory or specific file
    if [[ -d "seeds/demo" ]]; then
      run npx knex seed:run --specific=demo
    elif [[ -f "seeds/demo.js" || -f "seeds/demo.ts" ]]; then
      run npx knex seed:run --specific=demo.js 2>/dev/null || run npx knex seed:run --specific=demo.ts
    else
      warn "No demo seeds found (create seeds/demo/ directory or seeds/demo.js)"
    fi
  fi

  ok "Knex database reset complete"
}

reset_sequelize() {
  need_cmd npx

  # Drop all tables and re-migrate
  run npx sequelize-cli db:drop
  run npx sequelize-cli db:create
  run npx sequelize-cli db:migrate

  if [[ "$SEED" == true ]]; then
    run npx sequelize-cli db:seed:all
  fi

  if [[ "$DEMO" == true ]]; then
    # Convention: demo seeders have "demo" in filename
    if ls seeders/*demo* 1>/dev/null 2>&1; then
      for seeder in seeders/*demo*; do
        run npx sequelize-cli db:seed --seed "$(basename "$seeder")"
      done
    else
      warn "No demo seeders found (create seeders/*demo*.js files)"
    fi
  fi

  ok "Sequelize database reset complete"
}

reset_typeorm() {
  need_cmd npx

  # TypeORM: drop schema and run migrations
  run npx typeorm schema:drop
  run npx typeorm migration:run

  if [[ "$SEED" == true || "$DEMO" == true ]]; then
    # Convention: look for seed script in package.json
    if grep -q '"db:seed"' package.json 2>/dev/null; then
      run npm run db:seed
    elif grep -q '"seed"' package.json 2>/dev/null; then
      run npm run seed
    else
      warn "No seed script found in package.json"
    fi
  fi

  if [[ "$DEMO" == true ]]; then
    if grep -q '"db:seed:demo"' package.json 2>/dev/null; then
      run npm run db:seed:demo
    fi
  fi

  ok "TypeORM database reset complete"
}

reset_django() {
  local python_cmd="python"
  command -v python3 >/dev/null 2>&1 && python_cmd="python3"
  need_cmd "$python_cmd"

  # Flush database and re-migrate
  run $python_cmd manage.py flush --no-input
  run $python_cmd manage.py migrate

  if [[ "$SEED" == true ]]; then
    # Convention: loaddata with fixtures or custom seed command
    if [[ -d "fixtures" ]]; then
      for fixture in fixtures/*.json; do
        [[ -f "$fixture" ]] && run $python_cmd manage.py loaddata "$fixture"
      done
    elif grep -q '"seed"' manage.py 2>/dev/null || $python_cmd manage.py help seed >/dev/null 2>&1; then
      run $python_cmd manage.py seed
    else
      warn "No fixtures/ directory or seed command found"
    fi
  fi

  if [[ "$DEMO" == true ]]; then
    if [[ -f "fixtures/demo.json" ]]; then
      run $python_cmd manage.py loaddata fixtures/demo.json
    elif $python_cmd manage.py help seed_demo >/dev/null 2>&1; then
      run $python_cmd manage.py seed_demo
    else
      warn "No fixtures/demo.json or seed_demo command found for demo seeding"
    fi
  fi

  ok "Django database reset complete"
}

reset_alembic() {
  local python_cmd="python"
  command -v python3 >/dev/null 2>&1 && python_cmd="python3"
  need_cmd "$python_cmd"

  # Check if using Flask-Migrate or standalone Alembic
  if command -v flask >/dev/null 2>&1 && [[ -f "migrations/alembic.ini" ]]; then
    # Flask-Migrate
    run flask db downgrade base
    run flask db upgrade
  else
    # Standalone Alembic
    run alembic downgrade base
    run alembic upgrade head
  fi

  if [[ "$SEED" == true || "$DEMO" == true ]]; then
    # Convention: look for seed script
    if [[ -f "seed.py" ]]; then
      run $python_cmd seed.py
    elif [[ -f "scripts/seed.py" ]]; then
      run $python_cmd scripts/seed.py
    else
      warn "No seed.py or scripts/seed.py found"
    fi
  fi

  if [[ "$DEMO" == true ]]; then
    if [[ -f "seed_demo.py" ]]; then
      run $python_cmd seed_demo.py
    elif [[ -f "scripts/seed_demo.py" ]]; then
      run $python_cmd scripts/seed_demo.py
    else
      warn "No seed_demo.py found for demo seeding"
    fi
  fi

  ok "Alembic database reset complete"
}

reset_go_migrate() {
  # golang-migrate or similar
  need_cmd migrate

  # Need DATABASE_URL or similar
  local db_url="${DATABASE_URL:-}"
  local migrations_path="./migrations"
  [[ -d "db/migrations" ]] && migrations_path="./db/migrations"

  if [[ -z "$db_url" ]]; then
    # Try to load from .env
    if [[ -f ".env" ]]; then
      db_url=$(grep -E "^DATABASE_URL=" .env | cut -d'=' -f2- | tr -d '"' | tr -d "'")
    fi
  fi

  [[ -z "$db_url" ]] && die "DATABASE_URL not set. Export it or add to .env"

  run migrate -path "$migrations_path" -database "$db_url" drop -f
  run migrate -path "$migrations_path" -database "$db_url" up

  if [[ "$SEED" == true || "$DEMO" == true ]]; then
    # Convention: look for seed binary or script
    if [[ -f "cmd/seed/main.go" ]]; then
      run go run cmd/seed/main.go
    elif [[ -f "scripts/seed.go" ]]; then
      run go run scripts/seed.go
    else
      warn "No cmd/seed/main.go or scripts/seed.go found"
    fi
  fi

  if [[ "$DEMO" == true ]]; then
    if [[ -f "cmd/seed/main.go" ]]; then
      run go run cmd/seed/main.go --demo
    elif [[ -f "scripts/seed_demo.go" ]]; then
      run go run scripts/seed_demo.go
    else
      warn "No demo seed found (use --demo flag in seed or create scripts/seed_demo.go)"
    fi
  fi

  ok "Go database reset complete"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

main() {
  local env
  env=$(detect_env)

  log "Detected environment: $env"

  case "$env" in
    laravel)   reset_laravel ;;
    prisma)    reset_prisma ;;
    drizzle)   reset_drizzle ;;
    knex)      reset_knex ;;
    sequelize) reset_sequelize ;;
    typeorm)   reset_typeorm ;;
    django)    reset_django ;;
    alembic)   reset_alembic ;;
    go-migrate) reset_go_migrate ;;
    unknown)
      die "Could not detect project type. Supported: Laravel, Prisma, Drizzle, Knex, Sequelize, TypeORM, Django, Flask/Alembic, Go"
      ;;
  esac
}

main
