#!/usr/bin/env bash
# sandbox - Run commands in your configured sandbox directory
#
# Usage:
#   sandbox <command> [args...]    - Run command in sandbox directory
#   sandbox                        - Show sandbox path and stack
#   sandbox --path                 - Print sandbox path only
#   sandbox --stack                - Show detected stack in sandbox
#   sandbox --help                 - Show this help
#
# Configuration:
#   Set SANDBOX_PATH in tynn.config (copy from tynn.config.example)
#
# Examples:
#   sandbox resetme --demo
#   sandbox php artisan migrate
#   sandbox npm run dev
#   sandbox puse pest

set -euo pipefail

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Setup
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Source bashrc to load aliases
if [[ -f "${HOME}/.bashrc" ]]; then
  source "${HOME}/.bashrc" 2>/dev/null || true
  shopt -s expand_aliases 2>/dev/null || true
fi

# Find script directory and source libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$REPO_ROOT/lib/helpers.sh"
source "$REPO_ROOT/lib/stacks.sh"

# Source config
CONFIG_FILE="$REPO_ROOT/tynn.config"
if [[ ! -f "$CONFIG_FILE" ]]; then
  die "tynn.config not found. Copy tynn.config.example to tynn.config and set SANDBOX_PATH"
fi
source "$CONFIG_FILE"

if [[ -z "${SANDBOX_PATH:-}" ]]; then
  die "SANDBOX_PATH not set in tynn.config"
fi

if [[ ! -d "$SANDBOX_PATH" ]]; then
  die "SANDBOX_PATH directory does not exist: $SANDBOX_PATH"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Handle flags
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [[ $# -eq 0 ]]; then
  # No args - show path and detected stack
  echo "Sandbox: $SANDBOX_PATH"
  # Detect stack in sandbox directory
  (cd "$SANDBOX_PATH" && echo "Stack: $(stack_name "$(detect_stack)")")
  echo ""
  echo "ðŸ’¡ Use: sandbox <command> to run in sandbox"
  echo "ðŸ’¡ Use: cd \$(sandbox --path) to change directory"
  exit 0
fi

case "$1" in
  --path)
    echo "$SANDBOX_PATH"
    exit 0
    ;;
  --stack)
    (cd "$SANDBOX_PATH" && echo "$(stack_name "$(detect_stack)")")
    exit 0
    ;;
  --help|-h)
    sed -n '2,/^$/p' "$0" | sed 's/^# \?//'
    exit 0
    ;;
esac

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Run command in sandbox
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd="$1"
shift

log "Running in: $SANDBOX_PATH"

# Build command string with proper quoting
cmd_str="$cmd"
for arg in "$@"; do
  # Escape single quotes in args
  escaped_arg="${arg//\'/\'\\\'\'}"
  cmd_str="$cmd_str '$escaped_arg'"
done

# Execute in sandbox directory with aliases available
(cd "$SANDBOX_PATH" && bash -c "source ~/.bashrc 2>/dev/null; shopt -s expand_aliases; eval '$cmd_str'")
