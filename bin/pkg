#!/usr/bin/env bash
# pkg - Run commands in a monorepo package directory
#
# Usage:
#   pkg <command>              - Auto-detects single package
#   pkg <package-name> <cmd>   - Run in specific package
#   pkg --list                 - List available packages
#   pkg --help                 - Show this help
#
# Examples:
#   pkg php vendor/bin/pest
#   pkg laravel-fun-lab php vendor/bin/pest
#   pkg --list

set -euo pipefail

# ─────────────────────────────────────────────────────────────────────────────
# Setup
# ─────────────────────────────────────────────────────────────────────────────

# Source bashrc to load aliases
if [[ -f "${HOME}/.bashrc" ]]; then
  source "${HOME}/.bashrc" 2>/dev/null || true
  shopt -s expand_aliases 2>/dev/null || true
fi

# Find script directory and source libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$REPO_ROOT/lib/helpers.sh"

# ─────────────────────────────────────────────────────────────────────────────
# Find packages directory
# ─────────────────────────────────────────────────────────────────────────────

PKG_DIR="packages"

find_packages_root() {
  local search_dir="$PWD"
  while [[ "$search_dir" != "/" && "$search_dir" != "/c" ]]; do
    if [[ -d "$search_dir/$PKG_DIR" ]]; then
      echo "$search_dir/$PKG_DIR"
      return 0
    fi
    search_dir="$(dirname "$search_dir")"
  done
  return 1
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

show_help() {
  sed -n '2,/^$/p' "$0" | sed 's/^# \?//'
}

show_list() {
  local packages_path="$1"
  info "Packages in $packages_path:"
  ls -1 "$packages_path"
}

main() {
  # Handle flags
  case "${1:-}" in
    --help|-h)
      show_help
      exit 0
      ;;
    --list|-l)
      local packages_path
      packages_path=$(find_packages_root) || die "No 'packages/' directory found in project hierarchy"
      show_list "$packages_path"
      exit 0
      ;;
  esac

  # Find packages directory
  local packages_path
  packages_path=$(find_packages_root) || die "No 'packages/' directory found in project hierarchy"

  local package_count
  package_count="$(find "$packages_path" -maxdepth 1 -mindepth 1 -type d 2>/dev/null | wc -l | tr -d ' ')"

  if [[ $# -eq 0 ]]; then
    show_help
    echo ""
    show_list "$packages_path"
    exit 1
  fi

  local target=""

  # If first arg is a package name (directory exists), use it
  if [[ -d "$packages_path/$1" ]]; then
    target="$packages_path/$1"
    shift
  # If only one package exists, auto-select it
  elif [[ "$package_count" -eq 1 ]]; then
    target="$(find "$packages_path" -maxdepth 1 -mindepth 1 -type d 2>/dev/null | head -1)"
    log "Auto-selected: $(basename "$target")"
  else
    warn "Multiple packages found. Specify package name:"
    ls -1 "$packages_path" >&2
    exit 1
  fi

  if [[ $# -eq 0 ]]; then
    die "No command specified"
  fi

  local cmd="$1"
  shift

  # Build command string with proper quoting
  local cmd_str="$cmd"
  for arg in "$@"; do
    # Escape single quotes in args
    local escaped_arg="${arg//\'/\'\\\'\'}"
    cmd_str="$cmd_str '$escaped_arg'"
  done

  # Execute command in package directory
  log "Running in: $target"
  (cd "$target" && bash -c "source ~/.bashrc 2>/dev/null; shopt -s expand_aliases; eval '$cmd_str'")
}

main "$@"
